<div class="py-4">
    <div class="card card-event">
        <div id="cover" class="cover-bg-blur" style="background-image: url(<%=rails_blob_url( @event.cover) %>)"></div>
        <div id="cover-noblur" class="cover-bg" style="background-image: url(<%=rails_blob_url( @event.cover) %>)"></div>
        <div class="card-body">
            <div class="d-flex flex-wrap">
                <div>
                    <h4 class="m-0"><%= @event.title %></h4>
                    <%= link_to @event.user.username, user_path(@event.user) %>
                    <% if @event.user.verification %>
                    <div class="verified-icon"></div>
                    <% end %>
                    <br>
                    <%= @event.start.strftime("%e %B %Y, %H:%M") %> - <%= @event.end.strftime("%e %B %Y, %H:%M")%>
                </div>
                <div class="ml-auto">
                    <div class="text-right mb-2">
                        <span class="mr-2"><strong><%= @event.interested %></strong> Interested </span>
                        <strong><%= @event.going %></strong> Going </div>
                    <% if user_signed_in? %>
                    <div>
                        <% if current_user != @event.user && !current_user.admin %>
                        <button class="btn btn-danger">
                            <div class="flag-icon"></div>
                        </button>

                        <%if @part.nil? %>
                        <%= button_to( event_participations_path(@event), params: { participation: { value: "i" } },
                                        method: :post, form_class: "d-inline-block", class:"btn btn-primary" ) do %>
                        Interested
                        <% end %>
                        <%= button_to( event_participations_path(@event), params: { participation: { value: "p" } }, 
                                        method: :post, form_class: "d-inline-block", class:"btn btn-success" ) do %>

                        Going
                        <% end %>
                        <% elsif @part.value == 'i' %>
                            <%= link_to( event_participation_path(@event, @part), method: :delete , class:"btn btn-warning" ) do %>
                            Not interested
                            <% end %>
                            <%= button_to( event_participation_path(@event, @part), params: { participation: { value: "p" } }, 
                                            method: :put, form_class: "d-inline-block", class:"btn btn-success" ) do %>
                            Going
                            <% end %>
                        <% else %>
                            <%= button_to( event_participation_path(@event, @part), params: { participation: { value: "i" } }, 
                                            method: :put, form_class: "d-inline-block", class:"btn btn-primary" ) do %>
                            Interested
                            <% end %>
                            <%= link_to( event_participation_path(@event, @part), method: :delete , class:"btn btn-warning" ) do %>
                            Not Going
                            <% end %>
                        <% end %>
                        <% else %>
                        <%= link_to( edit_event_path(@event), class: "btn btn-warning") do%>
                        <div class="modify-icon"></div> Modify
                        <% end %>
                        <%= link_to( event_path(@event), data:{ confirm: "Are you sure? "}, class: "btn btn-danger", method: :delete) do%>
                        <div class="delete-icon"></div> Delete
                        <% end %>
                        <% end %>
                    </div>
                    <% end %>
                </div>
            </div>
        </div>
    </div>
    <br>
    <div class="card">
        <div class="card-body">
            <h6 class="card-title"> Description </h6>
            <%= @event.description %><br>
            <br>
            <h6 class="card-title"> Tags </h6>
            <div class="text-primary">
                <% @event.tags.each do |t| %>
                <%= t %>
                <%end%>
            </div>
        </div>
    </div>
    <br>

    <div class="card-deck">
        <div class="card" style="overflow:hidden">
            <div style="height: 300px" id="mapContainer" data-lat="<%= @event.coords[:lat] %>" data-lng="<%= @event.coords[:lng] %>"></div>
            <div class="card-body d-flex border-top">
                <div id="mapEventInfo"><%= @event.where %></div>
                <a class="ml-auto btn btn-primary" href="https://share.here.com/l/<%= "#{@event.coords[:lat]},#{@event.coords[:lng]}" %>?z=13&t=traffic&p=yes"> <div class="directions-icon" style="--icon-size: 36px;"></div> </a>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <%= form_with model: Comment.new, url: event_comments_path(@event), class: "form-inline flex-nowrap" do |f| %>
                <%= f.text_field :content, class: "form-control flex-grow-1 w-100", placeholder: "Write a comment" %>
                <%= button_tag(type: 'submit', class: "ml-3 btn btn-primary") do %>
                <div class="send-comment-icon"></div> 
                <% end %>
                <% end %>
            </div>
            <div class="card-body comments-container">
                <% @event.comments.each do |c| %>
                <div class="mb-3">
                    <div class="media" id="comment<%= c[:comment].id %>">
                        <%= image_tag c[:comment].user.avatar_thumbnail, class:"avatar align-self-center comments-avatar mr-3" %>
                        <div class="media-body comment">
                            <div class="d-flex">
                                <strong class="mr-auto"> <%= c[:comment].user.username %>
                                    <% if c[:comment].user.verification %>
                                    <div class="verified-icon"></div>
                                    <% end %>
                                </strong>
                                <% if c[:comment].isModified? %>
                                <span class="ml-auto text-muted"> Modified </span>
                                <% end %>
                            </div>
                            <%= c[:comment].content %>
                        </div>
                    </div>
                    <div class="replies">
                        <a data-toggle="collapse" href="#replyForm<%= c[:comment].id %>" role="button" aria-expanded="false" aria-controls="collapseExample">
                            reply
                        </a>
                        <% if user_signed_in? && (current_user == c[:comment].user || current_user.admin )%>
                        ·
                        <a class="text-warning" data-toggle="collapse" href="#modifyForm<%= c[:comment].id %>" role="button" aria-expanded="false" aria-controls="collapseExample">
                            modify
                        </a> ·
                        <%= link_to "delete", event_comment_path(@event, c[:comment]), data: { confirm: "Are you sure?" }, method: :delete , class:"text-danger" %>
                        <div class="collapse" id="modifyForm<%= c[:comment].id %>">
                            <%= form_with model: c[:comment], url: event_comment_path(@event,c[:comment]), method: "patch", class: "form-inline flex-nowrap mb-3" do |f| %>
                            <%= f.text_field :content, class: "form-control flex-grow-1 w-100", placeholder: "Write a comment" %>
                            <%= button_tag(type: 'submit', class: "ml-3 btn btn-warning") do %>
                            <div class="modify-icon"></div>
                            <% end %>
                            <% end %>
                        </div>
                        <% else %>
                        flag
                        <% end %>
                        <% c[:replies].each do |r| %>
                        <div class="my-2">
                            <div class="media" id="comment<%= r.id %>">
                                <%= image_tag r.user.avatar_thumbnail, class:"avatar align-self-center comments-avatar mr-3" %>
                                <div class="media-body comment">
                                    <div class="d-flex">
                                        <strong class="mr-auto"> <%= r.user.username %>
                                            <% if r.user.verification %>
                                            <div class="verified-icon"></div>
                                            <% end %>
                                        </strong>
                                        <% if r.isModified? %>
                                        <span class="ml-auto text-muted"> Modified </span>
                                        <% end %>
                                    </div>
                                    <%= r.content %>
                                </div>
                            </div>
                            <div class="replies">
                                <% if user_signed_in? && (current_user == c[:comment].user || current_user.admin )%>
                                <a class="text-warning" data-toggle="collapse" href="#modifyForm<%= r.id %>" role="button" aria-expanded="false" aria-controls="collapseExample">
                                    modify
                                </a> ·
                                <%= link_to "delete", event_comment_path(@event, r), data: { confirm: "Are you sure?" }, method: :delete , class:"text-danger" %>
                                <div class="collapse" id="modifyForm<%= r.id %>">
                                    <%= form_with model: r, url: event_comment_path(@event,r), method: "patch", class: "form-inline flex-nowrap mb-3" do |f| %>
                                    <%= f.text_field :content, class: "form-control flex-grow-1 w-100", placeholder: "Write a comment" %>
                                    <%= button_tag(type: 'submit', class: "ml-3 btn btn-warning") do %>
                                    <div class="modify-icon"></div>
                                    <% end %>
                                    <% end %>
                                </div>
                                <% else %>
                                flag
                                <% end %>
                            </div>
                        </div>
                        <%end%>
                        <div class="collapse" id="replyForm<%= c[:comment].id %>">
                            <%= form_with model: Comment.new, url: event_comments_path(@event), class: "form-inline flex-nowrap mb-3" do |f| %>
                            <%= f.hidden_field :previous_id, :value => c[:comment].id %>
                            <%= f.text_field :content, class: "form-control flex-grow-1 w-100", placeholder: "Write a comment" %>
                            <%= button_tag(type: 'submit', class: "ml-3 btn btn-primary") do %>
                            <div class="send-reply-icon"></div>
                            <% end %>
                            <% end %>
                        </div>
                    </div>
                </div>
                <% end %>
                <% if @event.comments.empty? %>
                <span class="text-muted"> This event has no comments yet </span>
                <%end%>
            </div>
        </div>
    </div>

</div>
